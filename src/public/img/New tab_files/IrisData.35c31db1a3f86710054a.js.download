(window.webpackJsonp=window.webpackJsonp||[]).push([["IrisData"],{Em1F:function(e,t){},QnRU:function(e,t,a){"use strict";a.d(t,"a",(function(){return N})),a.d(t,"c",(function(){return E})),a.d(t,"b",(function(){return w}));var s=a("D57K"),i=a("tMmC"),r=a("a0gC");const n=new class{getAllCampaigns(){return new Promise(e=>Object(s.b)(this,void 0,void 0,(function*(){try{(yield r.a.isUserNurturingApiAvailableToUse())?r.a.getUserNurturingPreferenceSetting("campaigns").then(t=>{t||i.a.logError("PSL: window.chrome.ntpSettingsPrivate.getPref does not have campaigns."),e(t||[])}):(i.a.logError("PSL: Error fetching campaigns due to window.chrome.ntpSettingsPrivate.getPref api not available for this version of EDGE"),e([]))}catch(t){i.a.logError(t),e([])}})))}persistCampaigns(e){return new Promise(t=>Object(s.b)(this,void 0,void 0,(function*(){try{(yield r.a.isUserNurturingApiAvailableToUse())?(yield r.a.saveUserNurturingPreferenceSetting("campaigns",e),i.a.log(`PSL: Number of campaigns persisted: ${e.length||0}.`),t(!0)):i.a.logError("PSL: Error persisting campaigns due to window.chrome.ntpSettingsPrivate.getPref api not available for this version of EDGE")}catch(e){i.a.logError(e)}t(!1)})))}clearPersistentStorage(){return this.persistCampaigns([])}};var o=a("dTwT");const c=new class{constructor(){this.storageKey="irisNewsLocalStorage"}getAllCampaigns(){try{return Object(o.a)().getObject(this.storageKey)}catch(e){return i.a.logError(`Exception ${e} occurred retrieving user nurturing campaigns from local storage`),[]}}storeCampaigns(e){try{return Object(o.a)().setObject(this.storageKey,e),i.a.log(`Number of campaigns persisted in local storage: ${e.length||0}.`),!0}catch(e){return i.a.logError(`Exception ${e} occurred storing user nurturing campaigns in local storage`),!1}}clearLocalStorage(){return this.storeCampaigns([])}};var u=a("HxRh"),l=a("rvYQ"),h=a("ADRF"),d=a("ax+D"),g=a("y+Kz"),f=a("I6Lx"),m=a("ypwz"),p=a("s9+9"),b=a("KRKw"),C=a("tERu"),S=a("ljWX"),y=a("VZ41"),O=a("XgsJ"),v=a("HDSB"),I=a("9J8d"),j=a("gqHb"),P=a("XLvf");const N=new class{constructor(){this.cachedSurfaceMap=new Map,this.irisSessionContextAttributes=new Map,this.enabledFeatures=[],this.millisecondsInADay=864e5,this.timeNow=(new Date).getTime(),this.appType=l.b&&l.b.AppType,this.appType===m.a.EdgeChromium&&this.getConfigDataAsync()}get isEnabled(){return!!this.shouldUseCache()||!(!this.irisDataConfig||!this.irisDataConfig.enableCaching)&&this.isCookieConsentNotRequired()}set IrisDataConfig(e){this.irisDataConfig=e}clearCachedSurfaceMap(){this.isEnabled&&this.cachedSurfaceMap.clear()}populateCachedSurfaceMap(){return Object(s.b)(this,void 0,void 0,(function*(){if(this.isEnabled)try{if(this.purgeCacheWithQsp())return yield this.clearCachedSurfacesFromStorage(),void i.a.log("Cache purged!");this.clearCachedSurfaceMap();let e=[];if(e=l.b.AppType===m.a.EdgeChromium?yield n.getAllCampaigns():c.getAllCampaigns(),!e||0===e.length)return void i.a.log("Bulk read of surfaces from local/persistent storage didn't return a surface.");const{subscribers:t}=this.irisDataConfig,a=[];Object.keys(t).forEach(e=>{t[e].active||a.push(S.c[e])}),e.forEach(e=>{e&&e.placement&&(0===a.length||-1===a.indexOf(e.placement))&&(i.a.log(`Populated ${e.placement} from local/persistent storage.`),this.cachedSurfaceMap.set(e.placement,e),this.highestLastAddedTime=0,e.creatives&&e.creatives.length>0&&e.creatives.forEach(e=>{e&&e.storageInfo&&e.storageInfo.lastAddedTime&&(this.highestLastAddedTime=e.storageInfo.lastAddedTime>=this.highestLastAddedTime?e.storageInfo.lastAddedTime:this.highestLastAddedTime)}))})}catch(e){i.a.logError("Bulk read of surfaces from local/persistent storage threw error: "+e)}}))}getLatestCachedSurface(e,t){if(!e||0===e.length||0===this.cachedSurfaceMap.size)return null;if(!this.cachedSurfaceMap.has(e))return null;const a=this.cachedSurfaceMap.get(e);if(!a||!a.creatives||0===a.creatives.length)return null;if(t!==S.d.MSNAnaheimNewsNTPImages)return a;const s=this.getStorageCachingExpiration();let i=!1;return a.creatives.forEach(e=>{e&&e.storageInfo&&e.storageInfo.lastAddedTime&&this.timeNow-e.storageInfo.lastAddedTime<s&&(i=!0)}),i?a:null}addSurfaceToMap(e){if(!e||!e.placement)return;const t=e.placement,a=new Map;if(this.cachedSurfaceMap.has(t)){this.cachedSurfaceMap.get(t).creatives.forEach(e=>{a.set(e.creativeId,e)})}e.creatives&&e.creatives.forEach(e=>{const t={useCount:0,lastAddedTime:this.timeNow};e.storageInfo=t,a.set(e.creativeId,e)}),e.creatives=[...a.values()],i.a.log(`Adding SurfaceInfo ${t} in storage.`),this.cachedSurfaceMap.set(t,e)}addSurfaceCollectionToStorage(e){return Object(s.b)(this,void 0,void 0,(function*(){e&&e.length>0&&(e.forEach(e=>{e.placement!==S.c[S.d.MSNAnaheimNewsNTPImages]&&e.placement!==S.c[S.d.MSNAnaheimNewsNTPImages+S.b]&&this.addSurfaceToMap(e)}),yield this.persistAllSurfaces())}))}persistAllSurfaces(){return Object(s.b)(this,void 0,void 0,(function*(){if(this.isEnabled){if(l.b.AppType===m.a.EdgeChromium)return void(yield n.persistCampaigns([...this.cachedSurfaceMap.values()]));c.storeCampaigns([...this.cachedSurfaceMap.values()])}}))}clearCachedSurfacesFromStorage(){return Object(s.b)(this,void 0,void 0,(function*(){this.isEnabled&&(this.clearCachedSurfaceMap(),l.b.AppType!==m.a.EdgeChromium?c.clearLocalStorage():yield n.clearPersistentStorage())}))}getCachedSurfaceMap(){return this.cachedSurfaceMap}HaveWeShownASurfaceRecently(){return this.highestLastAddedTime>0&&this.timeNow-this.highestLastAddedTime<this.getTimeBetweenShowingDifferentCreatives()}isUserSeenAllCreativesInSurface(e){if(!e||0===e.length)return!1;if(this.cachedSurfaceMap.has(e)){const t=this.cachedSurfaceMap.get(e);let a=0;if(t&&t.creatives&&t.creatives.length>0)return t.creatives.forEach(e=>{e.storageInfo&&e.storageInfo.useCount&&e.storageInfo.lastAddedTime&&(e.storageInfo.useCount>=this.getReshowingCounterForEachCreative()||this.timeNow-e.storageInfo.lastAddedTime<=this.getTimeBetweenReshowingSameCreative())&&a++}),t.creatives.length===a}return!1}filterCreatives(e){if(!e||!this.shouldUseMaximumCapPerCreative())return e;const t=this.irisDataConfig&&this.irisDataConfig.maximumCapPerCreative||2,a=[];return e.creatives.forEach(e=>{e.storageInfo&&e.storageInfo.useCount<=t&&a.push(e)}),e.creatives=a,e}updateAction(e,t,a){if(e&&t&&this.cachedSurfaceMap.has(e)){const s=this.cachedSurfaceMap.get(e);s&&s.creatives&&s.creatives.forEach(e=>{e.creativeId===t&&e.storageInfo&&(e.storageInfo.irisAction=a)})}}markCreativeAsSeenByUser(e,t){if(e&&t&&this.cachedSurfaceMap.has(e)){const a=this.cachedSurfaceMap.get(e);a&&a.creatives&&a.creatives.forEach(e=>{e&&e.creativeId&&e.creativeId===t&&e.storageInfo&&(e.storageInfo.useCount++,e.storageInfo.lastAddedTime=this.timeNow)})}}hasUserDismissedAllStoredSurfaceCreatives(e){if(!e||0===e.length)return!1;if(this.cachedSurfaceMap.has(e)){const t=this.cachedSurfaceMap.get(e);let a=0;if(t&&t.creatives&&t.creatives.length>0)return t.creatives.forEach(e=>{if(!e.storageInfo||!e.storageInfo.irisAction||e.storageInfo.irisAction!==y.a.Dismiss)return!1;a++}),t.creatives.length===a}return!1}updateCreativeLatestAddedTime(e,t,a){if(!this.cachedSurfaceMap.has(e))return;const s=this.cachedSurfaceMap.get(e);s&&s.creatives&&0!==s.creatives.length&&s.creatives.forEach(e=>{e&&e.creativeId===t&&e.storageInfo&&e.storageInfo.lastAddedTime&&(e.storageInfo.lastAddedTime=a)})}getStorageCachingExpiration(){return(this.irisDataConfig&&this.irisDataConfig.storageCachingExpiration||1)*this.millisecondsInADay}getReshowingCounterForEachCreative(){return this.irisDataConfig&&this.irisDataConfig.frequency||2}getTimeBetweenReshowingSameCreative(){return(this.irisDataConfig&&this.irisDataConfig.frequencyInterval||14)*this.millisecondsInADay}getTimeBetweenShowingDifferentCreatives(){return(this.irisDataConfig&&this.irisDataConfig.frequencyIntervalBetweenCreatives||1)*this.millisecondsInADay}purgeCacheWithQsp(){const e=Object(O.m)();if(e){const t=h.a.getQueryParameterByName("purgeCache",e);if(t&&"true"===t.toLocaleLowerCase())return!0}return!1}shouldUseCache(){const e=Object(O.m)();if(e){const t=h.a.getQueryParameterByName("useCache",e);if(t)return"true"===t.toLocaleLowerCase()}return!1}shouldUseMaximumCapPerCreative(){const e=Object(O.m)();if(e){const t=h.a.getQueryParameterByName("useMaxCapPerCreative",e);if(t)return"true"===t.toLocaleLowerCase()}return!0}isCookieConsentNotRequired(){const e=I.a.getInstance().rootReducer.connector(p.a.SharedState),t=e&&e.getCurrentState();return(t&&t.cookieConsentStatus)===b.b.NotRequired}getConfigDataAsync(){return Object(s.b)(this,void 0,void 0,(function*(){return this.getConfigDataPromise=new Promise(e=>{try{Object(v.a)()&&window&&window.chrome&&window.chrome.ntpSettingsPrivate&&"function"==typeof window.chrome.ntpSettingsPrivate.getConfigData?window.chrome.ntpSettingsPrivate.getConfigData(t=>{void 0!==t?(this.profileCreationTimeInMs=t.profileCreationTime,this.enabledFeatures=t.enabledFeatures,this.getIrisSessionContextAttributes(t.irisAttributes),this.configData=t,e()):(j.a.trackAppErrorEvent(Object.assign(Object.assign({},u.ab),{message:"Config data is undefined"})),e())}):(j.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Kb),{message:"Failed to fetch config data from chromium API"})),e())}catch(t){j.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Fb),{message:"Exception fetching config data from chromium API",pb:Object.assign(Object.assign({},u.Fb.pb),{customMessage:"Exception: "+t})})),e()}}),this.getConfigDataPromise}))}isBlackoutPeriodOver(){return Object(s.b)(this,void 0,void 0,(function*(){this.appType===m.a.EdgeChromium&&(yield this.getConfigDataPromise);const e=this.irisDataConfig.blackoutPeriodInDays&&this.irisDataConfig.blackoutPeriodInDays*this.millisecondsInADay||7*this.millisecondsInADay;return!!this.profileCreationTimeInMs&&this.timeNow-this.profileCreationTimeInMs>e}))}getIrisSessionContextAttribute(e){return Object(s.b)(this,void 0,void 0,(function*(){return this.appType===m.a.EdgeChromium&&(yield this.getConfigDataPromise),this.irisSessionContextAttributes.has(e)?this.irisSessionContextAttributes.get(e):""}))}getIrisSessionContextAttributes(e){if(d.a.isNotNullOrUndefined(e)&&e.length>0){e.startsWith("&")&&e.length>=1&&(e=e.substring(1));e.split("&").map(e=>e.split("=")).forEach(e=>{this.irisSessionContextAttributes.set(e[0],e[1])})}}isDefaultBrowserUpsellEnabled(){return Object(s.b)(this,void 0,void 0,(function*(){return this.appType===m.a.EdgeChromium&&(yield this.getConfigDataPromise),!!this.enabledFeatures&&this.enabledFeatures.indexOf("msNtpSpotlightSetEdgeAsDefault")>=0}))}isNurturingEnabled(){return Object(s.b)(this,void 0,void 0,(function*(){return this.appType===m.a.EdgeChromium&&(yield this.getConfigDataPromise),!!this.enabledFeatures&&this.enabledFeatures.indexOf("msUserNurturing")>=0}))}getConfigData(){return this.configData}};function E(){return Object(s.b)(this,void 0,void 0,(function*(){if(yield w())return!1;try{return!1!==Object(o.a)().getObject(g.t)}catch(e){return j.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Ob),{message:"Failed to fetch nurturing accepted key from local storage",pb:Object.assign(Object.assign({},u.Ob.pb),{customMessage:`Exception: ${e} occurred while reading key: ${g.t} from local storage.`})})),!1}}))}function w(){return Object(s.b)(this,void 0,void 0,(function*(){yield l.b.AccountInfoPromise;const e=l.b.ResolvedAccountInfo;return Object(P.isNullOrUndefined)(f.b.AadState)?C.b.AAD===(e&&e.account_type):f.b.AadState}))}},RUyI:function(e,t){},dkoE:function(e,t,a){"use strict";a.r(t),a.d(t,"IrisDataConnector",(function(){return D})),a.d(t,"IrisDataReducer",(function(){return U})),a.d(t,"irisImageLocalStorage",(function(){return s.a})),a.d(t,"IrisSurfaceName",(function(){return f.d})),a.d(t,"isAadAccount",(function(){return i.b})),a.d(t,"irisStorageUtility",(function(){return i.a})),a.d(t,"isNurturingAccepted",(function(){return i.c})),a.d(t,"RegisterErrorTrackingCallback",(function(){return N.a})),a.d(t,"ToolingInfo",(function(){return x}));var s=a("B5Qt"),i=a("QnRU"),r=a("Em1F"),n=a("D57K"),o=a("tMmC"),c=a("HxRh"),u=a("1w6q"),l=a("rvYQ"),h=a("dTwT"),d=a("ax+D"),g=a("ADRF"),f=a("ljWX"),m=a("VZ41"),p=a("SPwp"),b=a("Vvi2"),C=a("ypwz"),S=a("4wjP"),y=a("Ozxe");const O={[C.a.HomePage]:"1",[C.a.Edge+S.b.DHP]:"2",[C.a.EdgeChromium+S.b.DHP]:"2",[C.a.Edge+S.b.NTP]:"3",[C.a.EdgeChromium+S.b.NTP]:"3",[C.a.Windows]:"7",[C.a.WindowsShell]:"7",[C.a.Finance]:"8",[C.a.Hub]:"8",[C.a.Weather]:"8",[C.a.Views]:"9",[C.a.MicrosoftNews]:"11",[C.a.MMX+S.b.Launcher]:"12"},v={[y.a.Edge]:"1",[y.a.Chrome]:"2",[y.a.InternetExplorer]:"3",[y.a.Firefox]:"4",[y.a.Safari]:"5",[y.a.Chromium]:"6",[y.a.EdgeChromium]:"6"};var I=a("I6Lx"),j=a("hOj1"),P=a("pVDi"),N=a("gqHb"),E=a("r6MD"),w=a("XLvf");class A{static runValidation(e,t){return Object(n.b)(this,void 0,void 0,(function*(){switch(e){case f.d.MSNAnaheimNewsNTPImages:case f.d.MSNAnaheimNewsNTPImages+f.b:{const a=!Object(w.isNullOrUndefined)(t)&&t,r=s.a.getStoredImageData(),n=!!Object(w.isNullOrUndefined)(r)||s.a.imageHasTimedOut(r.imgExpiration),o=!Object(w.isNullOrUndefined)(r)&&I.b.Locale;if(!!o&&o===r.reqMarket&&!n&&!a)return;const c=[];l.b.CurrentRequestTargetScope&&l.b.CurrentRequestTargetScope.pageExperiments&&(-1!==l.b.CurrentRequestTargetScope.pageExperiments.indexOf("prg-hsptmtnow-t")?c.push("prg-hsptmtnow-t"):-1!==l.b.CurrentRequestTargetScope.pageExperiments.indexOf("prg-hsptinfo-t")&&c.push("prg-hsptinfo-t"));const u=yield i.a.isDefaultBrowserUpsellEnabled();u&&c.push("prg-dfltbrwsr-t");let h=null;c.length>0&&(h={aflights:c.join(";")});let d=null;if(a){d={xSdkIaf:s.a.getDislikeList()}}const g=yield i.a.getIrisSessionContextAttribute(f.a.defaultBrowser),m=yield i.a.getIrisSessionContextAttribute(f.a.operatingSystem),p=yield i.a.getIrisSessionContextAttribute(f.a.anaheimBuild),b=yield i.a.getIrisSessionContextAttribute(f.a.anaheimChannel);return{addToCall:!0,headers:Object.assign({},d),parameters:Object.assign(Object.assign({},h),A.getBackgroundImagesIrisCallParameters(e,u,g,m,p,b))}}case f.d.MSNNewsCoachmark:case f.d.MSNNewsCoachmark+f.b:return{addToCall:!0,parameters:{nocookie:"0"}};case f.d.ConditionalBanner:case f.d.ConditionalBanner+f.b:return{addToCall:!0,parameters:Object.assign({},A.getConditionalBannerIrisCallParameters(e))};case f.d.MSNewsRewards:case f.d.MSNewsRewards+f.b:return{addToCall:!0,parameters:{nocookie:"0"}};default:return void N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.Qe),{message:"Subscriber validation function not found.",pb:Object.assign(Object.assign({},c.Qe.pb),{customMessage:"Subscriber: "+e})}))}}))}static getBackgroundImagesIrisCallParameters(e,t,a,s,i,r){const n=new Object;if(n.nocookie="1",t){d.a.isNotNullOrUndefined(a)&&""!==a&&(n[f.a.defaultBrowser]=a),d.a.isNotNullOrUndefined(s)&&""!==s&&(n[f.a.operatingSystem]=s),d.a.isNotNullOrUndefined(i)&&""!==i&&(n[f.a.anaheimBuild]=i),d.a.isNotNullOrUndefined(r)&&""!==r&&(n[f.a.anaheimChannel]=r);const t=[];f.a.defaultBrowser in n||t.push(f.a.defaultBrowser),f.a.operatingSystem in n||t.push(f.a.operatingSystem),f.a.anaheimBuild in n||t.push(f.a.anaheimBuild),f.a.anaheimChannel in n||t.push(f.a.anaheimChannel),t.length>0&&N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.hd),{message:"Missing parameters for subscriber",pb:Object.assign(Object.assign({},c.hd.pb),{customMessage:`parameters ${t.toString()} for subscriber ${e}`})}))}return n}static getConditionalBannerIrisCallParameters(e){const t=new Object;t.nocookie="0";const a=Object(j.a)(I.b.AnonCookieName);t.ISSIGNEDIN=a?"1":"0";const s=Object(E.a)(I.b,"ClientSettings.apptype"),i=Object(E.a)(I.b,"ClientSettings.pagetype"),r=A.mapCanvasId(s,i);r&&(t.MSN_CANVAS=r),s===C.a.Edge&&l.b&&l.b.CurrentRequestTargetScope&&l.b.CurrentRequestTargetScope.os===P.a.Windows&&(t.OPSYS="WIN10");const n=Object(E.a)(I.b,"ClientSettings.browser");if(n){const e=n.ismobile;e&&(t.ISMOBILE="TRUE"===e.toUpperCase()?"1":"0");const a=v[n.browserType];a&&(t.BROWSER=a)}const o=[];return"ISSIGNEDIN"in t||o.push("ISSIGNEDIN"),"MSN_CANVAS"in t||o.push("MSN_CANVAS"),"ISMOBILE"in t||o.push("ISMOBILE"),"BROWSER"in t||o.push("BROWSER"),o.length>0&&N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.id),{message:"Missing parameters for subscriber",pb:Object.assign(Object.assign({},c.id.pb),{customMessage:`parameters ${o.toString()} for subscriber ${e}`})})),t}static mapCanvasId(e,t){let a=null;switch(e){case C.a.Edge:case C.a.EdgeChromium:case C.a.MMX:a=[e+t];break;default:a=e}return O[a]}}var M=a("u5KZ"),T=a("XgsJ");class D extends u.a{constructor(e,t,a,s,r,o,c){if(super(e,t,a,s,r,o,c),this.headers=[null],this.queryParameters=[null],this.surfaceInfoMap=new Map,o.disableIrisCalls||!o.subscribers)return void(this.callWasMade=!1);this.irisDataPromise=new Promise(e=>Object(n.b)(this,void 0,void 0,(function*(){i.a.IrisDataConfig=o,this.appType=l.b&&l.b.AppType,this.internalPlacementUsed=Object(f.j)(),this.appType?(this.isBlackoutPeriodOver=this.appType!==C.a.EdgeChromium||(yield i.a.isBlackoutPeriodOver()),this.isBlackoutPeriodOver&&(yield i.a.populateCachedSurfaceMap()),this.internalPlacementUsed===this.shouldUseCacheForInternalPlacements()&&Object.keys(this.config.subscribers).forEach(e=>{const t=this.internalPlacementUsed?e+f.b:e,a=f.c[t],s=i.a.getLatestCachedSurface(a,t);s&&s.placement&&this.surfaceInfoMap.set(a,s)}),yield this.prepareCallData(),!this.queryParameters||Object(w.isNullOrUndefined)(this.queryParameters[0])&&this.queryParameters.length<=1?this.callWasMade=!1:(this.callIris(),this.callWasMade=!0),e()):this.callWasMade=!1}))),this.irisDataPromise;const u=this.config.subscribers;Object.keys(u).forEach(e=>{const t=u[e].captureInitialStateOfCampaigns;if(t)for(const e in t)Object(h.a)().getObject(e)&&M.a.addOrUpdateTmplString(`userEligibleToSeeCoachmark_${e}:1`)})}sendActionUpdate(e,t,a,s,r){let n;e&&t&&f.c[f.d.MSNAnaheimNewsNTPImages]!==e&&f.c[f.d.MSNAnaheimNewsNTPImages+f.b]!==e&&(a===m.b.Impression?i.a.markCreativeAsSeenByUser(e,t):i.a.updateAction(e,t,r),i.a.persistAllSurfaces()),n=a===m.b.Impression?s.impressionUrl:p.a.formatTelemetryActionUrl(s.actionUrl,r);try{b.a.sendActionUpdate(n)}catch(e){o.a.log("IrisDataConnector: Failed to report iris action update beacon due to error: "+JSON.stringify(e))}}getImagePayload(e){return Object(n.b)(this,void 0,void 0,(function*(){return e&&(yield this.prepareCallData(!0),this.callIris(),this.callWasMade=!0),yield this.getPayload(f.d.MSNAnaheimNewsNTPImages)}))}getPayload(e){return Object(n.b)(this,void 0,void 0,(function*(){let t;yield this.irisDataPromise,this.callWasMade&&(yield this.irisCallPromise);let a=this.shouldUseRequestedIrisSurface();if(a&&(this.internalPlacementUsed&&(a+=f.b),t=f.c[a]),!t){const e=Array.from(this.surfaceInfoMap.keys());let a=0;do{t=e[Math.floor(Math.random()*e.length)]}while(a++<e.length)}const s=e&&this.internalPlacementUsed?e+f.b:e;return s&&t!==f.c[s]?f.d.MSNAnaheimNewsNTPImages===s||f.d.MSNAnaheimNewsNTPImages+f.b===s?(t=f.c[s],yield this.tryGetSurfaceInfo(t)):(o.a.log(`IrisDataConnector: Surface requested ${f.c[s]} by experience is not same as surface ${t} picked.`),null):yield this.tryGetSurfaceInfo(t)}))}tryGetSurfaceInfo(e){return Object(n.b)(this,void 0,void 0,(function*(){if(!this.surfaceInfoMap.has(e))return o.a.log(`IrisDataConnector: Placement: ${e} was not populated by local/persistent storage nor downloaded by network call.`),null;let t=this.surfaceInfoMap.get(e);return f.c[f.d.MSNAnaheimNewsNTPImages]===e||f.c[f.d.MSNAnaheimNewsNTPImages+f.b]===e||this.shouldBlockPsl()?t:(yield Object(i.b)())?(o.a.log(`IrisDataConnector: This is AAD user so not returning SurfaceInfo for: ${e} to experience.`),null):this.isUserNurturedWithOneSurface?(o.a.log(`IrisDataConnector: Already sent surfaceInfo so not returning SurfaceInfo for: ${e} to experience.`),null):i.a.HaveWeShownASurfaceRecently()?(o.a.log(`IrisDataConnector: Already shown a campaign within 24 hours so not returning SurfaceInfo for: ${e} to experience.`),null):i.a.isUserSeenAllCreativesInSurface(e)?(o.a.log(`IrisDataConnector: We have already shown this so not returning SurfaceInfo for: ${e} to experience.`),null):(t=i.a.filterCreatives(t),this.isUserNurturedWithOneSurface=!0,o.a.log(`IrisDataConnector: Returning SurfaceInfo for: ${e} to experience.`),t)}))}prepareCallData(e){return Object(n.b)(this,void 0,void 0,(function*(){const{subscribers:t}=this.config,a=[],s=[],r=[];let n;const o=yield i.a.isNurturingEnabled(),u=yield Object(i.c)();for(const i of Object.keys(t)){let l;if(!t[i].active)continue;const h=this.queryParameters.length,g=this.internalPlacementUsed?i+f.b:i,m=f.c[g];if(!m){N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.Re),{message:"Subscriber not found in iris placement dictionary",pb:Object.assign(Object.assign({},c.Re.pb),{customMessage:`Subscriber ${g} not found in dictionary`})}));continue}const p=f.c[f.d.MSNAnaheimNewsNTPImages]===m||f.c[f.d.MSNAnaheimNewsNTPImages+f.b]===m,b=!Object(w.isNullOrUndefined)(e)&&e;if((p||!b)&&((!this.appType||this.appType!==C.a.EdgeChromium||p||u&&o)&&(this.isBlackoutPeriodOver||p)&&(!this.surfaceInfoMap.has(m)||p&&b))){const{creativeCount:o,performValidation:u,staticQueryParams:f,aflights:b}=t[i];if(u&&(l=yield A.runValidation(g,e),!l||!l.addToCall))continue;let C=o||1;if(C=l&&l.parameters&&l.parameters.bcnt?l.parameters.bcnt:C,C<=0){N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.kb),{message:"Creative count value is negative or zero",pb:Object.assign(Object.assign({},c.kb.pb),{customMessage:"Creative count value is negative or zero : "+g})}));continue}if(p?(this.queryParameters[h]={placement:m},this.queryParameters[h].bcnt=C):(a.push(m),s.push(C)),d.a.isNotNullOrUndefined(f)&&(p?this.queryParameters[h]=Object.assign(Object.assign({},this.queryParameters[h]),f):n=Object.assign(Object.assign({},n),f)),l&&l.parameters&&d.a.isNotNullOrUndefined(l.parameters)&&(p?this.queryParameters[h]=Object.assign(Object.assign({},this.queryParameters[h]),l.parameters):n=Object.assign(Object.assign({},n),l.parameters)),l&&l.headers&&d.a.isNotNullOrUndefined(l.headers)&&(p?this.headers[h]=Object.assign({},l.headers):this.headers[0]=Object.assign(Object.assign({},this.headers),l.headers)),d.a.isNotNullOrUndefined(b)&&"object"==typeof b)for(const e in b)b[e]&&(p?this.queryParameters[h].aflights=b[e]:r.push(b[e]))}}if(d.a.isNotNullOrUndefined(this.config.dynamicQueryParams)){n=Object.assign(Object.assign({},n),this.config.dynamicQueryParams);for(let e=1;e<this.queryParameters.length;e++)this.queryParameters[e]=Object.assign(Object.assign({},this.queryParameters[e]),this.config.dynamicQueryParams)}a.length>0&&(this.queryParameters[0]={placement:a.join("|")},this.queryParameters[0]=Object.assign(Object.assign({},this.queryParameters[0]),n),this.queryParameters[0].bcnt=s.join("|"),this.queryParameters[0].aflights=r.join(";"))}))}callIris(){this.irisCallPromise=new Promise(e=>Object(n.b)(this,void 0,void 0,(function*(){try{for(let e=0;e<this.queryParameters.length;e++){if(Object(w.isNullOrUndefined)(this.queryParameters[e]))continue;this.surfaceCollection=yield b.a.requestSurfaceInfo(this.queryParameters[e],this.headers[e],this.config.irisEndpoint);const t=this.getSurfacesFromCollection();yield i.a.addSurfaceCollectionToStorage(t)}}catch(e){this.callWasMade=!1,M.a.sendAppErrorEvent(Object.assign(Object.assign({},c.Gb),{message:"IrisDataConnector: Exception requesting iris surfaces from data connector.",pb:Object.assign(Object.assign({},c.Gb.pb),{customMessage:`Error: ${JSON.stringify(e)} requestUrl: ${this.config.irisEndpoint} queryParameters: ${JSON.stringify(this.queryParameters)} headers: ${JSON.stringify(this.headers)}`})}))}this.queryParameters=[null],this.headers=[null],e()}))),this.irisCallPromise}getSurfacesFromCollection(){const e=this.config.subscribers;if(!(e&&this.surfaceCollection&&this.surfaceCollection.collection&&this.surfaceCollection.reqContext&&this.surfaceCollection.reqContext.queryParams&&this.surfaceCollection.reqContext.queryParams.placement))return null;const t=[];return Object.keys(e).forEach(a=>{const s=this.getSurfaceFromCollection(a);s&&s.placement&&(o.a.log(`IrisDataConnector: Parsed response for ${s.placement} from Iris network call. Now adding to map.`),t.push(s),this.surfaceInfoMap.set(s.placement,s),this.captureInitialEligibilityStateOfCampaigns(s,e[a].captureInitialStateOfCampaigns))}),t}getSurfaceFromCollection(e){const t=this.internalPlacementUsed?e+f.b:e,a=f.c[t],s=this.surfaceCollection.reqContext.queryParams.placement;let i;if(-1==s.indexOf("|")){if(this.surfaceCollection.collection.hasUnclaimedErrors()){return void this.surfaceCollection.collection.getUnclaimedErrors().forEach(e=>{N.a.trackAppErrorEvent(Object.assign(Object.assign({},c.Cb),{message:"Surface errors discovered",pb:Object.assign(Object.assign({},c.Cb.pb),{customMessage:`Error with surface: ${t} Code: ${e.code} Message: ${e.msg}`})}))})}if(a===s&&this.surfaceCollection.collection.hasUnknowns()){return i=this.surfaceCollection.collection.getUnknowns()[0],i&&!i.placement&&(i.placement=a),i}}return i=this.surfaceCollection.collection.get(a),i&&!i.placement&&(i.placement=a),i}captureInitialEligibilityStateOfCampaigns(e,t){e.creatives&&t&&"object"==typeof t&&e.creatives.forEach(a=>{let s=!1;for(const i in t)if(e.placement===t[i]&&a.creativeId===i){s=!0;break}const i=Object(h.a)().getObject(a.creativeId);Object(w.isNullOrUndefined)(i)&&Object(h.a)().setObject(a.creativeId,s)})}shouldUseCacheForInternalPlacements(){const e=Object(T.m)();if(e){const t=g.a.getQueryParameterByName("useCacheForInternalPlacements",e);if(t)return"true"===t.toLocaleLowerCase()}return!1}shouldUseRequestedIrisSurface(){const e=Object(T.m)();if(e){const t=g.a.getQueryParameterByName("irisSurface",e);if(t)return t}return null}shouldBlockPsl(){const e=Object(T.m)();if(e){const t=g.a.getQueryParameterByName("blockPsl",e);if(t)return"true"===t.toLocaleLowerCase()}return!1}}class U{reduce(){return null}}var k=a("RUyI");const x={experienceConfigSchema:r.IrisDataConfigSchema,mockConfig:k.mockConfig}}}]);